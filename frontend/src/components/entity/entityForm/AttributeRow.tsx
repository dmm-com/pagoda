import AddIcon from "@mui/icons-material/Add";
import DeleteOutlineIcon from "@mui/icons-material/DeleteOutline";
import GroupIcon from "@mui/icons-material/Group";
import {
  Box,
  Button,
  Checkbox,
  IconButton,
  Input,
  MenuItem,
  Select,
  TableCell,
  Theme,
  TableRow,
  Typography,
} from "@mui/material";
import { styled } from "@mui/material/styles";
import { makeStyles } from "@mui/styles";
import React, { FC, useMemo } from "react";
import { Link } from "react-router-dom";

import { aclPath } from "../../../Routes";
import { Entity } from "../../../apiclient/autogenerated";
import { AutoCompletedField } from "../../common/AutoCompletedField";

import { AttributeTypes } from "utils/Constants";

const useStyles = makeStyles<Theme>((theme) => ({
  button: {
    margin: theme.spacing(1),
  },
}));

const StyledTableRow = styled(TableRow)(({ theme }) => ({
  "&:nth-of-type(odd)": {
    backgroundColor: "white",
  },
  "&:nth-of-type(even)": {
    backgroundColor: "#607D8B0A",
  },
}));

interface Props {
  index: number;
  currentAttr: { [key: string]: any };
  allAttrs: { [key: string]: any }[];
  referralEntities: Entity[];
  setAttributes: (attributes: { [key: string]: any }[]) => void;
}

export const AttributeRow: FC<Props> = ({
  index,
  currentAttr,
  allAttrs,
  referralEntities,
  setAttributes,
}) => {
  const classes = useStyles();

  const handleAppendAttribute = (nextTo) => {
    setAttributes([
      ...allAttrs,
      {
        name: "",
        type: AttributeTypes.string.type,
        is_mandatory: false,
        is_delete_in_chain: false,
        refIds: [],
      },
    ]);
  };

  const handleDeleteAttribute = (index: number) => {
    if (allAttrs.filter((a) => !a.deleted).length > 1) {
      allAttrs[index] = {
        ...allAttrs[index],
        deleted: true,
      };
      setAttributes([...allAttrs]);
    }
  };

  const attributeTypeMenuItems = useMemo(() => {
    return Object.keys(AttributeTypes).map((typename, index) => (
      <MenuItem key={index} value={AttributeTypes[typename].type}>
        {AttributeTypes[typename].name}
      </MenuItem>
    ));
  }, []);

  const handleChangeAttributeValue = (
    index: number,
    key: string,
    value: any
  ) => {
    allAttrs[index][key] = value;
    setAttributes([...allAttrs]);
  };

  return (
    <StyledTableRow>
      <TableCell>
        <Input
          type="text"
          value={currentAttr.name}
          placeholder="属性名"
          sx={{ width: "100%" }}
          onChange={(e) =>
            handleChangeAttributeValue(index, "name", e.target.value)
          }
          error={currentAttr.name === ""}
        />
      </TableCell>

      <TableCell>
        <Box>
          <Box minWidth={100} marginX={1}>
            <Select
              fullWidth={true}
              value={currentAttr.type}
              disabled={currentAttr.id != null}
              onChange={(e) =>
                handleChangeAttributeValue(index, "type", e.target.value)
              }
            >
              {attributeTypeMenuItems}
            </Select>
          </Box>
          {(currentAttr.type & AttributeTypes.object.type) > 0 && (
            <Box minWidth={100} marginX={1}>
              <Typography>エンティティを選択</Typography>

              <AutoCompletedField
                options={referralEntities}
                getOptionLabel={(option: Entity) => option.name}
                defaultValue={referralEntities.filter((e) =>
                  currentAttr.refIds.includes(e.id)
                )}
                handleChangeSelectedValue={(value: Entity[]) => {
                  handleChangeAttributeValue(
                    index,
                    "refIds",
                    value.map((i) => i.id)
                  );
                }}
              />
            </Box>
          )}
        </Box>
      </TableCell>

      <TableCell>
        <Checkbox
          checked={currentAttr.is_mandatory}
          onChange={(e) =>
            handleChangeAttributeValue(index, "is_mandatory", e.target.checked)
          }
        />
      </TableCell>

      <TableCell>
        <Checkbox
          checked={currentAttr.is_delete_in_chain}
          onChange={(e) =>
            handleChangeAttributeValue(
              index,
              "is_delete_in_chain",
              e.target.checked
            )
          }
        />
      </TableCell>

      <TableCell>
        <IconButton
          className={classes.button}
          onClick={(e) => handleDeleteAttribute(index)}
        >
          <DeleteOutlineIcon />
        </IconButton>
      </TableCell>

      {/* This is a button to add new Attribute */}
      <TableCell>
        <IconButton className={classes.button} onClick={handleAppendAttribute}>
          <AddIcon />
        </IconButton>
      </TableCell>

      <TableCell>
        <Button
          variant="contained"
          color="primary"
          className={classes.button}
          startIcon={<GroupIcon />}
          component={Link}
          to={aclPath(currentAttr.id)}
          disabled={currentAttr.id == null}
        >
          ACL
        </Button>
      </TableCell>
    </StyledTableRow>
  );
};
